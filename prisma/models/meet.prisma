// 会议平台枚举
enum MeetingPlatform {
  TENCENT_MEETING // 腾讯会议
  ZOOM // Zoom
  TEAMS // Microsoft Teams
  DINGTALK // 钉钉
  FEISHU // 飞书
  WEBEX // Cisco Webex
  VOOV // 腾讯会议国际版
  OTHER // 其他平台
}

// 会议类型枚举
enum MeetingType {
  ONE_TIME // 一次性会议
  RECURRING // 周期性会议
  INSTANT // 即时会议
  SCHEDULED // 预定会议
  WEBINAR // 网络研讨会
}

// 文件类型枚举
enum FileType {
  VIDEO // 视频文件
  AUDIO // 音频文件
  TRANSCRIPT // 转录文件
  SUMMARY // 会议纪要
  CHAT // 聊天记录
  SHARED_SCREEN // 共享屏幕录制
  WHITEBOARD // 白板内容
  DOCUMENT // 文档
  OTHER // 其他类型
}

// 文件存储方式枚举
enum StorageType {
  LOCAL // 本地存储
  OSS // 阿里云OSS
  COS // 腾讯云COS
  S3 // AWS S3
  MINIO // MinIO
  URL // 外部URL
}

// 处理状态枚举
enum ProcessingStatus {
  PENDING // 待处理
  PROCESSING // 处理中
  COMPLETED // 已完成
  FAILED // 处理失败
  SKIPPED // 已跳过
}

// 通用会议记录模型
model Meetings {
  id String @id @default(cuid())

  // 平台和来源信息
  platform          MeetingPlatform // 会议平台
  platformMeetingId String          @db.VarChar(100) // 平台会议ID
  subMeetingId      String?         @db.VarChar(100) // 子会议ID，用于区分同一主会议下的不同子会议
  externalId        String?         @db.VarChar(100) // 外部系统ID

  // 会议基本信息
  title       String      @db.VarChar(500) // 会议标题
  description String?     @db.Text // 会议描述
  meetingCode String?     @db.VarChar(50) // 会议号码
  type        MeetingType @default(SCHEDULED)

  // 主持人和参与者
  hostPlatformUserId String? // Host's platform user ID
  hostPlatformUser   PlatformUser? @relation("HostedMeetings", fields: [hostPlatformUserId], references: [id])
  hostUserId         String? // 本地用户ID
  hostUserName       String? // 主持人姓名
  participantCount   Int? // 参与人数

  // 时间信息
  scheduledStartTime DateTime? // 预定开始时间
  startTime          DateTime? // 实际开始时间
  endTime            DateTime? // 实际结束时间
  scheduledEndTime   DateTime? // 预定结束时间
  durationSeconds    Int? // 持续时长(秒)
  timezone           String?   @db.VarChar(50) // 时区

  // 录制和处理状态
  hasRecording     Boolean          @default(false)
  recordingStatus  ProcessingStatus @default(PENDING) // Status for recording processing (e.g. video/audio file generation)
  processingStatus ProcessingStatus @default(PENDING) // Status for overall meeting processing (e.g. transcription, summary generation)

  // 元数据
  metadata Json? // 平台特定的元数据
  tags     String[] // 标签
  language String?  @db.VarChar(10) // 会议语言

  // 关联关系
  participations MeetingParticipation[] // 参会记录
  files          MeetingFile[] // 关联的文件
  transcripts    MeetingTranscript[] // 转录记录
  summaries      MeetingSummary[] // 关联的总结记录

  // 系统字段及时间
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // 软删除时间戳
  userId    String?

  @@unique([platform, platformMeetingId])
  @@index([platform])
  @@index([startTime])
  @@index([endTime])
  @@index([recordingStatus])
  @@index([processingStatus])
  @@index([tags])
  @@index([deletedAt]) // 软删除查询索引
  @@index([createdAt]) // 创建时间查询优化
  @@index([hostUserId]) // 主持人查询优化
  @@index([userId]) // 用户查询优化
  @@map("meeting_records")
}

model MeetingParticipation {
  id String @id @default(cuid())

  // 关联会议和用户
  meetingId String
  meeting   Meetings @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  platformUserId String
  platformUser   PlatformUser @relation(fields: [platformUserId], references: [id], onDelete: Cascade)

  // 参会行为数据
  joinTime        DateTime?
  leftTime        DateTime?
  durationSeconds Int? // 参与时长

  // 平台特定的参会数据
  instanceId  Int? // 腾讯会议实例ID
  userRole    Int? // 平台用户角色
  sessionData Json? // 本次参会的特定数据

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?

  @@index([meetingId])
}

// 会议文件模型
model MeetingFile {
  id String @id @default(cuid())

  // 关联会议
  meetingRecordId String
  meetingRecord   Meetings @relation(fields: [meetingRecordId], references: [id], onDelete: Cascade)

  // 文件基本信息
  fileName         String   @db.VarChar(255) // 文件名
  originalFileName String?  @db.VarChar(255) // 原始文件名
  fileType         FileType // 文件类型
  mimeType         String?  @db.VarChar(100) // MIME类型
  fileSize         BigInt? // 文件大小(字节)
  duration         Int? // 文件时长(秒，适用于音视频)

  // 存储信息
  storageType StorageType // 存储方式
  storagePath String?     @db.VarChar(1000) // 存储路径
  storageUrl  String?     @db.VarChar(2000) // 访问URL
  downloadUrl String?     @db.VarChar(2000) // 下载链接
  expiresAt   DateTime? // 链接过期时间

  // 文件内容(适用于文本文件)
  content     String? @db.Text // 文件文本内容
  contentHash String? @db.VarChar(64) // 内容哈希值

  // 处理状态
  processingStatus ProcessingStatus @default(PENDING)
  errorMessage     String? // 错误信息

  // 元数据
  metadata Json? // 文件元数据
  tags     String[] // 文件标签

  // 软删除
  deletedAt DateTime? // 软删除时间戳

  // 系统字段
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  MeetingSummary MeetingSummary[]

  @@index([meetingRecordId])
  @@index([fileType])
  @@index([storageType])
  @@index([processingStatus])
  @@index([deletedAt])
  @@index([createdAt])
  @@index([contentHash])
  @@index([fileName]) // 文件名查询优化
  @@map("meeting_files")
}

// 平台用户信息表
model PlatformUser {
  id String @id @default(cuid())

  // 平台信息
  platform       MeetingPlatform // 会议平台
  platformUserId String // 平台用户ID

  // 用户基本信息
  userName   String? // 用户显示名称
  userEmail  String? // 用户邮箱
  userPhone  String? // 用户电话
  userAvatar String? // 用户头像URL

  // 本地用户关联
  userId String? // 关联到本地用户表
  user   User?   @relation(fields: [userId], references: [id])

  // 平台特定数据
  platformData Json? // 存储各平台特有的数据
  phoneHash    String? // 腾讯会议加密手机号

  // 用户状态
  isActive   Boolean   @default(true)
  lastSeenAt DateTime? // 最后出现时间

  // 关联关系
  participations       MeetingParticipation[] // 参会记录
  hostedMeetings       Meetings[]             @relation("HostedMeetings") // 主持的会议
  participantSummaries ParticipantSummary[] // 参与者会议总结

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([platform, platformUserId]) // 确保平台用户ID唯一
  @@index([userEmail])
  @@index([userId])
  @@index([phoneHash])
  @@index([platform])
  @@index([userName]) // 用户名查询优化
  @@index([isActive]) // 活跃用户查询优化
  @@index([lastSeenAt]) // 最后出现时间查询优化
}

model MeetingTranscript {
  id        String   @id @default(cuid()) // Unique identifier for the transcript
  meetingId String // Reference ID to the associated meeting
  meeting   Meetings @relation(fields: [meetingId], references: [id])

  platformUserId String? @db.VarChar(100) // Platform user ID

  paragraphId String  @db.VarChar(100) // Corresponds to minutes.paragraphs[].pid
  speakerName String? @db.VarChar(100) // Name of the speaker in the transcript
  startTime   BigInt // Timestamp in milliseconds for when this segment starts
  endTime     BigInt // Timestamp in milliseconds for when this segment ends
  text        String  @db.Text // The actual transcript text content

  userId String? // Optional reference to local system User ID (if matched)

  createdAt DateTime @default(now()) // Timestamp when the record was created
  updatedAt DateTime @updatedAt // Timestamp when the record was last updated

  @@index([meetingId]) // Index for meeting lookup optimization
  @@index([startTime]) // Index for timestamp-based queries
  @@index([endTime]) // Index for end time queries
  @@index([paragraphId]) // Index for paragraph-based lookups
  @@index([platformUserId]) // 平台用户查询优化
  @@index([userId]) // 本地用户查询优化
}

// 总结来源类型枚举
enum SummarySourceType {
  RECORDING // 录制文件
  TRANSCRIPT // 转录文件
  MANUAL // 手动创建
  HYBRID // 混合方式
}

// 生成方式枚举
enum GenerationMethod {
  AI // AI生成
  MANUAL // 手动创建
  HYBRID // 混合方式
}

// 会议总结表
model MeetingSummary {
  id String @id @default(cuid())

  // 关联会议
  meetingId String
  meeting   Meetings @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // 总结来源信息
  sourceType   SummarySourceType // 来源类型
  sourceFileId String? // 关联的录制文件ID
  sourceFile   MeetingFile?      @relation(fields: [sourceFileId], references: [id])

  // 总结内容
  title        String? @db.VarChar(500) // 总结标题
  content      String  @db.Text // 总结内容
  keyPoints    Json? // 关键要点
  actionItems  Json? // 行动项
  decisions    Json? // 决策记录
  participants Json? // 参与者总结

  // 生成信息
  generatedBy GenerationMethod? // 生成方式
  aiModel     String? // AI模型版本
  confidence  Float? // 置信度
  language    String? // 总结语言

  // 版本控制
  version         Int              @default(1)
  isLatest        Boolean          @default(true)
  parentSummaryId String? // 父总结ID（用于版本链）
  parentSummary   MeetingSummary?  @relation("SummaryVersions", fields: [parentSummaryId], references: [id])
  childSummaries  MeetingSummary[] @relation("SummaryVersions")

  // 状态管理
  status         ProcessingStatus @default(PENDING)
  processingTime Int? // 处理耗时（毫秒）
  errorMessage   String? // 错误信息

  // 用户交互
  createdBy  String? // 创建者
  creator    User?     @relation("SummaryCreator", fields: [createdBy], references: [id])
  reviewedBy String? // 审核者
  reviewer   User?     @relation("ReviewedSummaries", fields: [reviewedBy], references: [id])
  reviewedAt DateTime? // 审核时间

  // 元数据
  metadata Json? // 扩展元数据
  tags     String[] // 标签

  // 软删除
  deletedAt DateTime? // 软删除时间戳

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([meetingId])
  @@index([sourceType])
  @@index([isLatest])
  @@index([status])
  @@index([createdBy])
  @@index([version])
  @@index([language]) // 语言查询优化
  @@index([reviewedBy]) // 审核者查询优化
  @@map("meeting_summaries")
}


// 参与者会议总结表（包含单次会议和周期性总结）
model ParticipantSummary {
  id String @id @default(cuid())

  // 平台用户ID（单次会议必填，周期性总结不填）
  platformUserId String?
  platformUser   PlatformUser? @relation(fields: [platformUserId], references: [id], onDelete: Restrict)

  // 用户ID（周期性总结必填，单次会议不填）
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 周期类型（SINGLE=单次会议, DAILY/WEEKLY/MONTHLY=周期性总结）
  periodType PeriodType

  // ===== 单次会议字段（仅 periodType=SINGLE 时使用）=====
  recordFile     String?   @db.VarChar(500) // 录制文件路径
  recordFileId   String?   @db.VarChar(100) // 会议录制ID
  meetStartTime  DateTime? // 会议开始时间
  meetingSummary String?   @db.Text // 整个会议的总结

  // ===== 周期性总结字段（仅 periodType!=SINGLE 时使用）=====
  summaryDate DateTime? // 总结日期（表示这个总结所属的时间段）

  // ===== 通用字段 =====
  meetParticipant    String @db.VarChar(100) // 参会人信息
  participantSummary String @db.Text // 总结内容

  // ===== 关系字段（通过 SummaryRelation 表关联）=====
  asParent SummaryRelation[] @relation("ParentSummary") // 作为父级总结，包含哪些子级总结
  asChild  SummaryRelation[] @relation("ChildSummary") // 作为子级总结，属于哪些父级总结

  // 软删除
  deletedAt DateTime? // 软删除时间戳

  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([platformUserId])
  @@index([userId]) // 用户查询优化
  @@index([periodType]) // 周期类型查询优化
  @@index([recordFileId])
  @@index([meetStartTime])
  @@index([summaryDate]) // 总结日期查询优化
  @@index([createdAt])
  @@index([deletedAt]) // 软删除查询优化
  @@map("participant_summaries")
}


// 周期类型枚举（包含单次）
enum PeriodType {
  SINGLE // 单次会议
  DAILY // 每日
  WEEKLY // 每周
  MONTHLY // 每月
  QUARTERLY // 每季度
  YEARLY // 每年
}

// 总结关系表（记录总结之间的层级关系）
// 支持：单次→每日、每日→每周、每周→每月、每月→每年等
model SummaryRelation {
  id String @id @default(cuid())

  // 父级总结ID（更高层级的总结，如每日、每周、每月）
  parentSummaryId String
  parentSummary   ParticipantSummary @relation("ParentSummary", fields: [parentSummaryId], references: [id], onDelete: Cascade)

  // 子级总结ID（更低层级的总结，如单次、每日、每周）
  childSummaryId String
  childSummary   ParticipantSummary @relation("ChildSummary", fields: [childSummaryId], references: [id], onDelete: Cascade)

  // 父级周期类型（方便查询，表示父级是什么类型的总结）
  parentPeriodType PeriodType

  createdAt DateTime @default(now())

  @@unique([parentSummaryId, childSummaryId]) // 防止重复关联
  @@index([parentSummaryId])
  @@index([childSummaryId])
  @@index([parentPeriodType])
  @@map("summary_relations")
}
