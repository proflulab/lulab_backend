model Meeting {
  id String @id @default(cuid())

  // 平台和来源信息
  platform     MeetingPlatform // 会议平台
  meetingId    String          @map("meeting_id") @db.VarChar(100) // 平台会议ID
  subMeetingId String?         @map("sub_meeting_id") @db.VarChar(100) // 子会议ID，用于区分同一主会议下的不同子会议
  externalId   String?         @map("external_id") @db.VarChar(100) // 外部系统ID

  // 会议基本信息
  title       String      @db.VarChar(500) // 会议标题
  description String?     @db.Text // 会议描述
  meetingCode String?     @map("meeting_code") @db.VarChar(50) // 会议号码
  type        MeetingType @default(SCHEDULED)
  language    String?     @db.VarChar(10) // 会议语言
  tags        String[] // 标签

  // 主持人和参与者
  createdById      String?       @map("created_by_id") // Creator's platform user ID
  createdBy        PlatformUser? @relation("MeetingCreator", fields: [createdById], references: [id], onDelete: SetNull)
  hostId           String?       @map("host_id") // Host's platform user ID
  host             PlatformUser? @relation("HostedMeetings", fields: [hostId], references: [id], onDelete: SetNull)
  participantCount Int? // 参与人数

  // 时间信息
  scheduledStartAt DateTime? @map("scheduled_start_at") @db.Timestamptz(6) // 预定开始时间
  scheduledEndAt   DateTime? @map("scheduled_end_at") @db.Timestamptz(6) // 预定结束时间
  startAt          DateTime? @map("start_at") @db.Timestamptz(6) // 实际开始时间
  endAt            DateTime? @map("end_at") @db.Timestamptz(6) // 实际结束时间
  durationSeconds  Int?      @map("duration_seconds") // 持续时长(秒)
  timezone         String?   @db.VarChar(50) // 时区

  // 录制和处理状态
  hasRecording     Boolean          @default(false)
  recordingStatus  ProcessingStatus @default(PENDING) // Status for recording processing (e.g. video/audio file generation)
  processingStatus ProcessingStatus @default(PENDING) // Status for overall meeting processing (e.g. transcription, summary generation)

  // 元数据
  metadata Json? @default("{}") @db.JsonB // 平台特定的元数据

  // 关联关系
  participants MeetingParticipant[] // 参会记录
  recordings   MeetingRecording[] // 关联的录制
  summaries    MeetingSummary[] // 关联的总结记录

  // 系统字段及时间
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@unique([platform, meetingId])
  @@index([platform])
  @@index([startAt])
  @@index([endAt])
  @@index([recordingStatus])
  @@index([processingStatus])
  @@index([tags])
  @@index([deletedAt]) // 软删除查询索引
  @@index([createdAt]) // 创建时间查询优化
  @@index([platform, startAt]) // 按平台查询会议列表
  @@index([hostId, startAt]) // 查询主持人的会议
  @@index([createdById, startAt]) // 查询创建者的会议
  @@index([deletedAt, createdAt]) // 软删除查询优化
  @@map("meetings")
}

model MeetingRecording {
  id        String @id @default(cuid())
  meetingId String @map("meeting_id")

  source  RecordingSource @default(PLATFORM_AUTO)
  startAt DateTime?       @map("start_at") @db.Timestamptz(6)
  endAt   DateTime?       @map("end_at") @db.Timestamptz(6)
  status  RecordingStatus @default(RECORDING)

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  recorderUserId String?       @map("recorder_user_id")
  recorderUser   PlatformUser? @relation("RecordingUser", fields: [recorderUserId], references: [id], onDelete: SetNull)

  files       MeetingRecordingFile[]
  transcripts Transcript[]

  // 系统字段及时间
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6) // 软删除时间戳

  @@index([meetingId], map: "idx_recordings_meeting")
  @@map("meet_recordings")
}

model MeetingRecordingFile {
  id           String            @id @default(cuid())
  recordingId  String            @map("recording_id")
  fileObjectId String            @map("file_object_id") @db.Uuid
  fileType     RecordingFileType @default(VIDEO) @map("file_type")
  durationMs   BigInt?           @map("duration_ms")
  resolution   String?

  recording MeetingRecording @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  object    StorageObject    @relation(fields: [fileObjectId], references: [id], onDelete: Restrict)

  // 系统字段及时间
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6) // 软删除时间戳

  @@index([recordingId], map: "idx_recording_files_recording")
  @@map("meet_recording_files")
}

// 会议总结表
model MeetingSummary {
  id String @id @default(cuid())

  // 总结内容
  title        String? @db.VarChar(500) // 总结标题
  content      String  @db.Text // 总结内容
  keyPoints    Json? // 关键要点
  actionItems  Json? // 行动项
  decisions    Json? // 决策记录
  participants Json? // 参与者总结

  // 生成信息
  generatedBy GenerationMethod? // 生成方式
  aiModel     String? // AI模型版本
  confidence  Float? // 置信度
  language    String? // 总结语言

  // 版本控制
  version         Int              @default(1)
  isLatest        Boolean          @default(true)
  parentSummaryId String? // 父总结ID（用于版本链）
  parentSummary   MeetingSummary?  @relation("SummaryVersions", fields: [parentSummaryId], references: [id])
  childSummaries  MeetingSummary[] @relation("SummaryVersions")

  // 状态管理
  status         ProcessingStatus @default(PENDING)
  processingTime Int? // 处理耗时（毫秒）
  errorMessage   String? // 错误信息

  // 用户交互
  createdBy  String? // 创建者
  creator    PlatformUser? @relation("SummaryCreator", fields: [createdBy], references: [id])
  reviewedBy String? // 审核者
  reviewer   PlatformUser? @relation("ReviewedSummaries", fields: [reviewedBy], references: [id])
  reviewedAt DateTime? // 审核时间

  // 元数据
  metadata Json? // 扩展元数据
  tags     String[] // 标签

  // 关联会议
  meetingId    String
  meeting      Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  // 关联转录
  transcriptId String?
  transcript   Transcript? @relation(fields: [transcriptId], references: [id], onDelete: SetNull)

  // 软删除
  deletedAt DateTime? // 软删除时间戳

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([meetingId])
  @@index([isLatest])
  @@index([status])
  @@index([createdBy])
  @@index([version])
  @@index([language]) // 语言查询优化
  @@index([reviewedBy]) // 审核者查询优化
  @@index([meetingId, isLatest]) // 查询会议的最新总结
  @@index([status, createdAt]) // 按状态查询总结列表
  @@map("meet_summaries")
}

model MeetingParticipant {
  id String @id @default(cuid())

  // 关联会议和用户
  meetingId String
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // 参会人员
  platformUserId String
  platformUser   PlatformUser? @relation("ParticipantUser", fields: [platformUserId], references: [id], onDelete: Cascade)

  // 参会行为数据
  joinTime        DateTime?
  leftTime        DateTime?
  durationSeconds Int? // 参与时长

  // 平台特定的参会数据
  instanceId  Int? // 腾讯会议实例ID
  userRole    Int? // 平台用户角色
  sessionData Json? // 本次参会的特定数据

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([meetingId])
  @@index([platformUserId])
  @@map("meet_participants")
}

model MeetingUserAction {
  id String @id @default(cuid())

  action     String
  targetType String  @map("target_type")
  targetId   String? @map("target_id") @db.Uuid
  metadata   Json    @default("{}") @db.JsonB
  ip         String? @db.Inet
  userAgent  String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  platformUserId String?       @map("user_id")
  platformUser   PlatformUser? @relation("UserActions", fields: [platformUserId], references: [id], onDelete: SetNull)

  @@index([platformUserId, createdAt], map: "idx_actions_user_time")
  @@index([targetType, targetId], map: "idx_actions_target")
  @@map("meet_user_actions")
}

// 录制来源枚举
enum RecordingSource {
  PLATFORM_AUTO // 平台自动录制
  USER_MANUAL // 用户手动录制
  THIRD_PARTY // 第三方录制
}

// 录制状态枚举
enum RecordingStatus {
  RECORDING // 录制中
  PROCESSING // 处理中
  COMPLETED // 已完成
  FAILED // 失败
}

// 录制文件类型枚举
enum RecordingFileType {
  VIDEO // 视频
  AUDIO // 音频
  TRANSCRIPT // 转录文本
  CHAT // 聊天记录
}

// 生成方式枚举
enum GenerationMethod {
  AI // AI生成
  MANUAL // 手动创建
  HYBRID // 混合方式
}

// 会议平台枚举
enum MeetingPlatform {
  TENCENT_MEETING // 腾讯会议
  ZOOM // Zoom
  TEAMS // Microsoft Teams
  DINGTALK // 钉钉
  FEISHU // 飞书
  WEBEX // Cisco Webex
  VOOV // 腾讯会议国际版
  OTHER // 其他平台
}

// 会议类型枚举
enum MeetingType {
  ONE_TIME // 一次性会议
  RECURRING // 周期性会议
  INSTANT // 即时会议
  SCHEDULED // 预定会议
  WEBINAR // 网络研讨会
}

// 文件类型枚举
enum FileType {
  VIDEO // 视频文件
  AUDIO // 音频文件
  TRANSCRIPT // 转录文件
  SUMMARY // 会议纪要
  CHAT // 聊天记录
  SHARED_SCREEN // 共享屏幕录制
  WHITEBOARD // 白板内容
  DOCUMENT // 文档
  OTHER // 其他类型
}

// 处理状态枚举
enum ProcessingStatus {
  PENDING // 待处理
  PROCESSING // 处理中
  COMPLETED // 已完成
  FAILED // 处理失败
  SKIPPED // 已跳过
}
