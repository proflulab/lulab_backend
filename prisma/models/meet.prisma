// 会议平台枚举
enum MeetingPlatform {
    TENCENT_MEETING // 腾讯会议
    ZOOM // Zoom
    TEAMS // Microsoft Teams
    DINGTALK // 钉钉
    FEISHU // 飞书
    WEBEX // Cisco Webex
    VOOV // 腾讯会议国际版
    OTHER // 其他平台
}

// 会议类型枚举
enum MeetingType {
    ONE_TIME // 一次性会议
    RECURRING // 周期性会议
    INSTANT // 即时会议
    SCHEDULED // 预定会议
    WEBINAR // 网络研讨会
}

// 文件类型枚举
enum FileType {
    VIDEO // 视频文件
    AUDIO // 音频文件
    TRANSCRIPT // 转录文件
    SUMMARY // 会议纪要
    CHAT // 聊天记录
    SHARED_SCREEN // 共享屏幕录制
    WHITEBOARD // 白板内容
    DOCUMENT // 文档
    OTHER // 其他类型
}

// 文件存储方式枚举
enum StorageType {
    LOCAL // 本地存储
    OSS // 阿里云OSS
    COS // 腾讯云COS
    S3 // AWS S3
    MINIO // MinIO
    URL // 外部URL
}

// 处理状态枚举
enum ProcessingStatus {
    PENDING // 待处理
    PROCESSING // 处理中
    COMPLETED // 已完成
    FAILED // 处理失败
    SKIPPED // 已跳过
}

// 通用会议记录模型
model Meetings {
    id String @id @default(cuid())

    // 平台和来源信息
    platform            MeetingPlatform // 会议平台
    platformMeetingId   String // 平台会议ID
    subMeetingId        String? // 子会议ID，用于区分同一主会议下的不同子会议
    platformRecordingId String? // 平台录制ID
    externalId          String? // 外部系统ID

    // 会议基本信息
    title       String // 会议标题
    description String? // 会议描述
    meetingCode String? // 会议号码
    type        MeetingType @default(SCHEDULED)

    // 主持人和参与者
    hostUserId       String? // 主持人用户ID
    hostUser         User?   @relation("HostedMeetings", fields: [hostUserId], references: [id])
    hostUserName     String? // 主持人姓名
    hostEmail        String? // 主持人邮箱
    participantCount Int? // 参与人数
    participantList  Json? // 参与者详细列表

    // 时间信息
    scheduledStartAt DateTime? // 预定开始时间
    actualStartAt    DateTime? // 实际开始时间
    endedAt          DateTime? // 结束时间
    duration         Int? // 持续时长(分钟)
    timezone         String?   @db.VarChar(50) // 时区

    // 录制和处理状态
    hasRecording     Boolean          @default(false)
    recordingStatus  ProcessingStatus @default(PENDING)
    processingStatus ProcessingStatus @default(PENDING)

    // AI处理结果
    transcript  Json? // 完整转录文本
    summary     String? // 会议总结
    keyPoints   Json? // 关键要点
    actionItems Json? // 行动项
    decisions   Json? // 决策记录

    // 元数据
    metadata Json? // 平台特定的元数据
    tags     String[] // 标签
    language String?  @db.VarChar(10) // 会议语言

    // 关联关系
    participants MeetingParticipant[] // 参与者
    files        MeetingFile[] // 关联的文件
    transcripts  MeetingTranscript[] // 转录记录

    // 系统字段及时间
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime? // 软删除时间戳

    @@unique([platform, platformMeetingId])
    @@index([platform])
    @@index([hostUserId])
    @@index([actualStartAt])
    @@index([recordingStatus])
    @@index([processingStatus])
    @@index([tags])
    @@index([deletedAt]) // 软删除查询索引
    @@index([createdAt]) // 创建时间查询优化
    @@map("meeting_records")
}

model MeetingParticipant {
    id        String   @id @default(cuid())
    meetingId String
    meeting   Meetings @relation(fields: [meetingId], references: [id])

    userId String? // 可能是本地user表的id（如果能关联上）
    user   User?   @relation(fields: [userId], references: [id])

    uuid       String?
    userName   String?
    phoneHash  String? // 腾讯会议加密手机号
    joinTime   DateTime?
    leftTime   DateTime?
    instanceId Int?
    userRole   Int?
    msOpenId   String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([meetingId])
    @@index([phoneHash])
}

// 会议文件模型
model MeetingFile {
    id String @id @default(cuid())

    // 关联会议
    meetingRecordId String
    meetingRecord   Meetings @relation(fields: [meetingRecordId], references: [id], onDelete: Cascade)

    // 文件基本信息
    fileName         String // 文件名
    originalFileName String? // 原始文件名
    fileType         FileType // 文件类型
    mimeType         String? // MIME类型
    fileSize         BigInt? // 文件大小(字节)
    duration         Int? // 文件时长(秒，适用于音视频)

    // 存储信息
    storageType StorageType // 存储方式
    storagePath String? // 存储路径
    storageUrl  String? // 访问URL
    downloadUrl String? // 下载链接
    expiresAt   DateTime? // 链接过期时间

    // 文件内容(适用于文本文件)
    content     String? // 文件文本内容
    contentHash String? // 内容哈希值

    // 处理状态
    processingStatus ProcessingStatus @default(PENDING)
    errorMessage     String? // 错误信息

    // 元数据
    metadata Json? // 文件元数据
    tags     String[] // 文件标签

    // 软删除
    deletedAt DateTime? // 软删除时间戳

    // 系统字段
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([meetingRecordId])
    @@index([fileType])
    @@index([storageType])
    @@index([processingStatus])
    @@map("meeting_files")
}

model MeetingTranscript {
    id        String   @id @default(cuid())
    meetingId String
    meeting   Meetings @relation(fields: [meetingId], references: [id])

    paragraphId String // 对应 minutes.paragraphs[].pid
    speakerId   String? // 腾讯会议的userid
    speakerName String?
    startTime   Int // 毫秒或秒
    endTime     Int
    text        String

    userId String? // 你自己系统User的id（可选，匹配上就关联，没有就为空）
    user   User?   @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([meetingId])
    @@index([speakerId])
}
