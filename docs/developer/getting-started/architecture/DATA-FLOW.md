# 数据流设计文档

本文档详细描述了 LuLab 后端系统中的各种数据流处理流程，包括事件处理、文件处理、数据同步和业务流程。

## 腾讯会议事件处理流程

```text
1. 腾讯会议平台发送Webhook事件
         ↓
2. TencentWebhookController 接收并验证请求
         ├── 请求签名验证 (验证失败: 返回401)
         ├── 请求体解密 (解密失败: 返回400)
         └── 事件格式验证 (格式错误: 返回422)
         ↓
3. TencentEventHandlerService 事件分发
         ├── 事件类型识别
         └── 路由到对应处理器 (未知类型: 记录日志并跳过)
         ↓
4. EventHandlerFactory 选择具体事件处理器
         ├── 根据事件类型创建处理器实例
         └── 注入必要依赖 (失败: 记录错误并返回500)
         ↓
5. 具体事件处理器处理业务逻辑
         ├── 数据解析和验证
         ├── 业务规则检查
         ├── 数据转换和映射
         └── 错误处理和重试机制
         ↓
6. 数据持久化到PostgreSQL数据库
         ├── 事务处理 (失败: 回滚并记录错误)
         ├── 数据验证 (验证失败: 记录错误)
         └── 唯一性检查 (冲突: 更新现有记录)
         ↓
7. (可选) 同步数据到飞书多维表格
         ├── 创建同步任务
         ├── 加入队列 (失败: 记录错误并重试)
         └── 异步处理 (不阻塞主流程)
         ↓
8. 返回处理结果
         ├── 成功: 返回200和事件ID
         └── 失败: 返回错误码和错误信息
```

**错误处理策略**:
- 签名验证失败: 直接拒绝，记录安全日志
- 数据解密失败: 记录错误，返回客户端错误
- 业务处理失败: 记录详细错误，支持重试机制
- 数据库操作失败: 事务回滚，记录错误日志
- 第三方API调用失败: 指数退避重试，熔断机制

## 会议录制文件处理流程

```text
1. 接收录制完成事件 (RecordingCompletedHandler)
         ↓
2. 事件数据验证和解析
         ├── 验证必要字段存在
         ├── 解析录制文件列表
         └── 提取会议和文件元数据
         ↓
3. 调用腾讯会议API获取录制文件详情
         ├── 构建API请求 (包含认证信息)
         ├── 发送HTTP请求 (失败: 重试3次)
         └── 解析响应数据 (格式错误: 记录并跳过)
         ↓
4. 下载录制文件（HttpFileUtil）
         ├── 创建下载任务
         ├── 流式下载文件 (网络错误: 断点续传)
         ├── 校验文件完整性 (失败: 重新下载)
         └── 临时存储 (下载完成后移动)
         ↓
5. 存储文件到对象存储
         ├── 生成唯一文件路径
         ├── 上传到OSS/COS (失败: 重试)
         ├── 设置访问权限和元数据
         └── 删除本地临时文件
         ↓
6. 提取文件元数据
         ├── 文件大小和格式
         ├── 创建和修改时间
         ├── 视频时长和分辨率
         └── 缩略图生成 (异步)
         ↓
7. 创建或更新数据库记录
         ├── 开启数据库事务
         ├── 创建MeetingRecording记录
         ├── 创建MeetingRecordingFile记录
         └── 提交事务 (失败: 回滚)
         ↓
8. 同步到飞书 Bitable (通过 RecordingFileBitableRepository)
         ├── 创建同步任务
         ├── 加入队列
         └── 异步处理 (不阻塞主流程)
         ↓
9. 触发后续处理流程
         ├── AI转录任务 (如配置)
         ├── 通知相关人员
         └── 更新会议状态
```

**错误处理策略**:
- API调用失败: 指数退避重试，最大重试次数
- 文件下载失败: 支持断点续传，多次重试
- 对象存储失败: 本地备份，定期重试
- 数据库操作失败: 事务回滚，详细错误日志

## 飞书 Bitable 数据同步流程

```text
1. 业务事件触发数据更新
         ├── 数据库记录创建/更新
         ├── 事件发布到消息队列
         └── 同步任务创建
         ↓
2. BitableRepository 接收数据操作请求
         ├── 从队列获取任务
         ├── 解析任务参数
         └── 验证任务有效性
         ↓
3. 数据验证和类型转换 (FieldValidator)
         ├── 必填字段检查
         ├── 数据类型转换
         ├── 字段长度限制
         └── 特殊字符处理
         ↓
4. LarkClient 调用飞书 Bitable API
         ├── 构建API请求 (包含认证信息)
         ├── 请求限流控制
         ├── 发送HTTP请求 (失败: 重试)
         └── 解析响应数据
         ↓
5. Upsert 操作（基于唯一键去重）
         ├── 查询现有记录
         ├── 存在则更新，不存在则创建
         ├── 处理字段映射
         └── 处理关联记录
         ↓
6. 返回操作结果和记录 ID
         ├── 更新本地同步状态
         ├── 记录同步日志
         └── 清理临时数据
```

**错误处理策略**:
- 数据验证失败: 记录错误，跳过同步
- API限流: 自动退避，延迟重试
- 网络错误: 指数退避重试
- 数据冲突: 记录冲突，人工干预

## 用户认证流程

```text
1. 用户提交登录请求
         ├── 接收登录凭据 (用户名/密码/验证码)
         ├── 基本格式验证
         └── 请求频率检查 (超限: 返回429)
         ↓
2. LoginService 验证用户凭据
         ├── 查询用户记录 (不存在: 返回401)
         ├── 验证密码/验证码 (错误: 记录失败次数)
         ├── 检查账户状态 (禁用/锁定: 返回403)
         └── 更新最后登录时间
         ↓
3. TokenService 生成 JWT Token
         ├── 生成访问令牌 (包含用户ID、权限)
         ├── 生成刷新令牌
         ├── 设置令牌过期时间
         └── 存储刷新令牌到数据库
         ↓
4. 记录登录日志 (LoginLogRepository)
         ├── 创建登录记录
         ├── 记录IP地址和设备信息
         └── 异步保存 (不阻塞响应)
         ↓
5. 返回认证信息
         ├── 返回访问令牌和刷新令牌
         ├── 返回用户基本信息
         └── 设置令牌过期时间
```

**安全措施**:
- 密码错误次数限制: 超过阈值锁定账户
- 令牌黑名单: 支持令牌撤销
- 刷新令牌轮换: 提高安全性
- 登录异常检测: 异地登录告警

## 邮件/短信验证码流程

```text
1. 用户请求发送验证码
         ├── 接收手机号/邮箱
         ├── 格式验证
         └── 频率限制检查 (超限: 返回429)
         ↓
2. VerificationService 生成验证码
         ├── 生成随机验证码
         ├── 设置过期时间 (通常5-10分钟)
         ├── 计算验证码哈希 (不存储原文)
         └── 生成唯一请求ID
         ↓
3. 调用第三方服务发送 (Aliyun SMS / Email Service)
         ├── 构建发送请求
         ├── 调用API (失败: 重试)
         ├── 记录发送结果
         └── 处理回调 (如支持)
         ↓
4. 存储验证码记录 (VerificationRepository)
         ├── 保存验证码哈希
         ├── 保存过期时间
         ├── 保存请求ID
         └── 保存发送状态
         ↓
5. 用户提交验证码进行验证
         ├── 接收用户输入
         ├── 查询验证码记录
         ├── 验证码比对 (使用哈希)
         ├── 检查过期时间
         ├── 检查使用次数
         └── 标记为已使用
```

**安全措施**:
- 验证码哈希存储: 不存储明文
- 一次性使用: 使用后立即失效
- 频率限制: 防止轰炸攻击
- 复杂度要求: 数字+字母组合

## 异步任务处理流程

```text
1. 业务操作触发任务
         ├── 创建任务定义
         ├── 设置任务参数
         ├── 设置优先级和延迟
         └── 添加到任务队列
         ↓
2. 任务加入 BullMQ 队列
         ├── 序列化任务数据
         ├── 设置任务选项 (重试、延迟等)
         ├── 添加到指定队列
         └── 返回任务ID
         ↓
3. Redis 存储队列数据
         ├── 任务数据存储
         ├── 任务状态跟踪
         ├── 重试计数
         └── 死信队列处理
         ↓
4. TaskProcessor 处理任务
         ├── 从队列获取任务
         ├── 反序列化任务数据
         ├── 执行业务逻辑
         ├── 异常处理和重试
         └── 更新任务状态
         ↓
5. 更新任务状态到数据库
         ├── 记录执行结果
         ├── 保存执行日志
         ├── 更新进度信息
         └── 清理临时数据
```

**错误处理策略**:
- 任务执行失败: 自动重试，指数退避
- 死信队列: 超过重试次数的任务进入死信队列
- 任务超时: 设置执行超时，防止阻塞
- 资源限制: 控制并发任务数量

## AI 功能处理流程

```text
1. 会议录制/转录完成
         ├── 检测到新录制文件
         ├── 验证文件格式
         └── 创建AI处理任务
         ↓
2. 触发 AI 处理任务
         ├── 设置任务类型 (转录/总结/分析)
         ├── 配置处理参数
         ├── 设置优先级
         └── 添加到AI任务队列
         ↓
3. 调用 OpenAI API 进行处理
         ├── 准备请求数据
         ├── 调用API (失败: 重试)
         ├── 流式处理大文件
         └── 处理API响应
         ↓
4. 生成会议总结/分析
         ├── 文本内容分析
         ├── 关键信息提取
         ├── 生成结构化数据
         └── 创建可视化内容
         ↓
5. 存储结果到数据库
         ├── 保存AI处理结果
         ├── 关联原始会议记录
         ├── 标记处理状态
         └── 更新处理时间
         ↓
6. 同步到飞书多维表格
         ├── 创建同步任务
         ├── 数据格式转换
         ├── 上传到飞书表格
         └── 更新同步状态
```

**错误处理策略**:
- API调用失败: 指数退避重试，熔断机制
- 内容处理失败: 记录错误，部分成功处理
- 结果存储失败: 临时保存，定期重试
- 同步失败: 异步重试，不阻塞主流程