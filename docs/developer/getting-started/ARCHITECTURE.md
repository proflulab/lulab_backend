# 系统架构设计文档

## 概述

本文档提供了 LuLab 后端系统的架构概览和详细文档索引。LuLab 后端是一个基于 NestJS 的企业级会议和用户服务系统，提供用户认证、会议管理、第三方服务集成等功能。

## 整体架构概览

### 系统架构图

```text
                    ┌─────────────────────────────────────────────────────────────┐
                    │                    客户端/第三方服务                        │
                    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
                    │  │   Web UI    │  │  移动应用    │  │   第三方API集成       │  │
                    │  └─────────────┘  └─────────────┘  └─────────────────────┘  │
                    └─────────────────────┬───────────────────────────────────────┘
                                          │ HTTPS/WebSocket/Webhook
                    ┌─────────────────────▼───────────────────────────────────────┐
                    │                        API网关                              │
                    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
                    │  │   路由管理    │  │   限流控制    │  │    请求验证         │  │
                    │  └─────────────┘  └─────────────┘  └─────────────────────┘  │
                    └─────────────────────┬───────────────────────────────────────┘
                                          │
                    ┌─────────────────────▼───────────────────────────────────────┐
                    │                     负载均衡器                              │
                    │              (Nginx/HAProxy/ALB)                           │
                    └─────────────────────┬───────────────────────────────────────┘
                                          │
        ┌─────────────────────────────────┼───────────────────────────────────────┐
        │                                 │                                       │
┌───────▼────────┐              ┌────────▼────────┐                     ┌───────▼────────┐
│   应用实例1     │              │   应用实例2      │                     │   应用实例N     │
│   (NestJS)      │              │   (NestJS)      │                     │   (NestJS)      │
│ ┌─────────────┐ │              │ ┌─────────────┐ │                     │ ┌─────────────┐ │
│ │ 认证模块     │ │              │ │ 认证模块     │ │                     │ │ 认证模块     │ │
│ │ 会议模块     │ │              │ │ 会议模块     │ │                     │ │ 会议模块     │ │
│ │ 集成模块     │ │              │ │ 集成模块     │ │                     │ │ 集成模块     │ │
│ │ 业务模块     │ │              │ │ 业务模块     │ │                     │ │ 业务模块     │ │
│ └─────────────┘ │              │ └─────────────┘ │                     │ └─────────────┘ │
└─────────────────┘              └─────────────────┘                     └─────────────────┘
        │                                 │                                       │
        └─────────────────────────────────┼───────────────────────────────────────┘
                                          │
        ┌─────────────────────────────────┼───────────────────────────────────────┐
        │                                 │                                       │
┌───────▼────────┐              ┌────────▼────────┐                     ┌───────▼────────┐
│   PostgreSQL   │              │     Redis       │                     │   对象存储      │
│   主数据库      │              │   缓存/队列      │                     │  (OSS/COS)     │
│                │              │                 │                     │                │
│ ┌─────────────┐ │              │ ┌─────────────┐ │                     │ ┌─────────────┐ │
│ │ 用户数据     │ │              │ │ 会话存储     │ │                     │ │ 录制文件     │ │
│ │ 会议数据     │ │              │ │ 任务队列     │ │                     │ │ 附件文件     │ │
│ │ 业务数据     │ │              │ │ 临时缓存     │ │                     │ │ 静态资源     │ │
│ └─────────────┘ │              │ └─────────────┘ │                     │ └─────────────┘ │
└─────────────────┘              └─────────────────┘                     └─────────────────┘
                                          │
        ┌─────────────────────────────────┼───────────────────────────────────────┐
        │                                 │                                       │
┌───────▼────────┐              ┌────────▼────────┐                     ┌───────▼────────┐
│   腾讯会议API   │              │     飞书API      │                     │   第三方服务     │
│                │              │                 │                     │                │
│ ┌─────────────┐ │              │ ┌─────────────┐ │                     │ ┌─────────────┐ │
│ │ Webhook事件  │ │              │ │ 多维表格     │ │                     │ │ 阿里云短信    │ │
│ │ 会议录制     │ │              │ │ 通知消息     │ │                     │ │ 邮件服务     │ │
│ │ 参会者管理   │ │              │ │ 应用集成     │ │                     │ │ OpenAI API  │ │
│ └─────────────┘ │              │ └─────────────┘ │                     │ └─────────────┘ │
└─────────────────┘              └─────────────────┘                     └─────────────────┘
```

## 技术栈概览

### 后端核心技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **Node.js** | 18.x+ | 运行时环境 | 提供高性能的 JavaScript/TypeScript 运行环境 |
| **NestJS** | 10.x | 应用框架 | 基于 TypeScript 的企业级 Node.js 框架，提供模块化架构 |
| **TypeScript** | 5.x | 编程语言 | 提供静态类型检查，增强代码可维护性 |
| **Prisma** | 5.x | ORM 工具 | 类型安全的数据库访问层，提供自动生成的客户端 |
| **PostgreSQL** | 14+ | 关系型数据库 | 主数据库，存储所有业务数据 |
| **Redis** | 7.x | 内存数据库 | 缓存、会话存储和任务队列支持 |
| **Swagger** | 7.x | API 文档 | 自动生成和展示 RESTful API 文档 |
| **Jest** | 29.x | 测试框架 | 单元测试和集成测试框架 |
| **Supertest** | 6.x | API 测试 | HTTP 断言库，用于测试 API 端点 |
| **pnpm** | 8.x | 包管理器 | 高效的磁盘空间利用和依赖管理 |
| **BullMQ** | 4.x | 任务队列 | 基于 Redis 的任务队列系统 |
| **@nestjs/schedule** | 4.x | 任务调度 | 定时任务和 cron 作业支持 |
| **Apollo Server** | 4.x | GraphQL 服务器 | 提供 GraphQL API 能力 |
| **Passport** | 0.6.x | 认证中间件 | 认证策略框架，支持多种认证方式 |
| **bcryptjs** | 2.4.x | 密码加密 | 安全的密码哈希算法 |
| **class-validator** | 0.14.x | 数据验证 | 基于装饰器的数据验证 |
| **class-transformer** | 0.5.x | 数据转换 | 对象转换和序列化工具 |

### 第三方服务集成

| 服务 | 集成方式 | 主要功能 | 用途 |
|------|----------|----------|------|
| **腾讯会议** | Webhook + REST API | 会议事件、录制文件、参会者管理、转写、智能功能 | 接收会议事件，获取录制文件，管理会议数据 |
| **飞书** | Open API + Webhook | 多维表格、通知消息、应用集成 | 数据同步、通知推送、业务协作 |
| **阿里云** | SDK + API | 短信服务、对象存储、邮件服务 | 短信验证码、文件存储、邮件发送 |
| **OpenAI** | REST API | 自然语言处理、智能分析 | 内容分析、智能摘要、自动化处理 |

## 架构文档索引

以下文档详细描述了系统架构的各个方面：

### 核心架构文档

| 文档 | 描述 |
|------|------|
| [技术栈](./architecture/TECH-STACK.md) | 详细介绍系统使用的技术栈和第三方服务集成 |
| [模块设计](./architecture/MODULES.md) | 系统模块划分和各模块的职责与交互 |
| [数据流设计](./architecture/DATA-FLOW.md) | 系统数据流和处理逻辑 |
| [数据库设计](./architecture/DATABASE.md) | 数据库模型、关系和优化策略 |
| [项目结构](./architecture/PROJECT-STRUCTURE.md) | 项目目录结构和组织方式 |

### 部署与运维文档

| 文档 | 描述 |
|------|------|
| [部署架构](./architecture/DEPLOYMENT.md) | 系统部署架构和环境配置 |
| [安全架构](./architecture/SECURITY.md) | 系统安全设计和实现 |
| [性能优化](./architecture/PERFORMANCE-OPTIMIZATION.md) | 性能优化策略和实施方案 |
| [监控策略](./architecture/MONITORING.md) | 系统监控、日志和告警策略 |

### 扩展性文档

| 文档 | 描述 |
|------|------|
| [扩展性设计](./architecture/EXTENSIBILITY.md) | 系统扩展性设计和实施方案 |
| [版本管理](./architecture/VERSIONING.md) | API版本控制和数据库版本管理 |
| [错误处理](./architecture/ERROR-HANDLING.md) | 系统错误处理和容错机制 |

## 开发指南

### 快速开始

1. **环境准备**:
   - 安装 Node.js 18.x+ 和 pnpm
   - 安装 PostgreSQL 14+ 和 Redis 7.x
   - 配置环境变量

2. **项目设置**:
   ```bash
   # 克隆项目
   git clone <repository-url>
   cd lulab_backend
   
   # 安装依赖
   pnpm install
   
   # 配置环境变量
   cp .env.example .env
   # 编辑 .env 文件，配置必要的环境变量
   
   # 数据库设置
   pnpm db:generate
   pnpm db:migrate
   pnpm db:seed
   
   # 启动开发服务器
   pnpm start:dev
   ```

3. **访问应用**:
   - API 文档: http://localhost:3000/api
   - 健康检查: http://localhost:3000/health

### 开发流程

1. **代码规范**:
   - 使用 ESLint 和 Prettier 进行代码格式化
   - 遵循 TypeScript 严格模式
   - 编写单元测试和集成测试

2. **提交规范**:
   - 使用 Conventional Commits 规范
   - 提交前运行测试和代码检查
   - 创建 Pull Request 进行代码审查

3. **测试流程**:
   ```bash
   # 运行单元测试
   pnpm test:unit
   
   # 运行集成测试
   pnpm test:integration
   
   # 运行所有测试
   pnpm test:all
   
   # 生成测试覆盖率报告
   pnpm test:cov
   ```

## 部署指南

### 环境配置

系统支持多环境部署，包括开发、测试和生产环境。每个环境有独立的配置和数据库实例。

### 部署方式

1. **传统部署**:
   - 使用 PM2 进行进程管理
   - Nginx 作为反向代理和负载均衡器
   - PostgreSQL 主从复制和 Redis 集群

2. **容器化部署**:
   - 使用 Docker 和 Docker Compose
   - Kubernetes 集群部署
   - Helm Charts 管理部署配置

### 监控和日志

- 使用 Prometheus 和 Grafana 进行指标监控
- ELK Stack 进行日志聚合和分析
- OpenTelemetry 进行分布式追踪

## 总结

LuLab 后端系统采用现代化的技术栈和架构设计，具有高性能、高可用、易扩展的特点。通过模块化设计和微服务架构，系统可以灵活应对业务需求的变化。详细的架构文档可以帮助开发团队更好地理解和维护系统。

如需了解特定方面的详细信息，请参考相应的架构文档。