# 系统架构设计文档

## 概述

本文档详细描述了项目的系统架构设计，包括整体架构、模块划分、数据流和关键技术选型。

## 整体架构

### 架构图

```text
┌─────────────────────────────────────────────────────────────┐
│                    客户端/第三方服务                        │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP/Webhook请求
┌─────────────────────▼───────────────────────────────────────┐
│                        API网关                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                     负载均衡器                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──────┐ ┌────▼──────┐ ┌────▼──────┐
│   应用实例1  │ │ 应用实例2 │ │ 应用实例N │
└───────┬──────┘ └────┬──────┘ └────┬──────┘
        │             │             │
        └─────────────┼─────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──────┐ ┌────▼──────┐ ┌────▼──────┐
│   PostgreSQL │ │ 飞书服务  │ │ 对象存储  │
│     数据库   │ │           │ │ (OSS/COS) │
└──────────────┘ └───────────┘ └───────────┘
```

## 技术栈

### 后端技术栈

- 框架: NestJS (Node.js)
- 语言: TypeScript
- 数据库: PostgreSQL
- ORM: Prisma
- API 文档: Swagger/OpenAPI
- 测试: Jest + Supertest
- 构建: Nest build（tsc/SWC）
- 依赖管理: pnpm

### 第三方服务集成

- **腾讯会议**: Webhook事件接收和API调用
- **飞书**: 多维表格数据同步
- **阿里云**: 短信服务
- **邮件服务**: SMTP/邮件API

## 模块划分

### 核心模块

#### 1. 认证模块 (Auth Module)

- 用例服务拆分（聚合服务已移除）：
  - RegisterService：注册流程（验证码校验、用户创建、欢迎邮件、登录日志）
  - LoginService：登录流程（密码/验证码、限流、登录日志、最后登录时间）
  - PasswordService：重置密码（验证码校验、密码强度校验、通知邮件）
  - ProfileService：用户资料（获取/更新、唯一性校验）
  - TokenService：令牌签发与刷新
  - AuthPolicyService：登录策略（失败次数限制、登录日志、类型映射）
- 仓储层：
  - UserRepository：用户与档案读写
  - LoginLogRepository：登录日志统计与写入
  - 说明：原 AuthRepository 已拆分并移除

#### 2. 会议模块 (Meeting Module)

- 会议记录管理
- 会议数据存储
- 会议文件处理
- 会议参与者管理

#### 3. 腾讯会议集成模块 (Tencent Meeting Module)

- Webhook事件处理
- API服务调用
- 数据解密和验证
- 事件分发和处理

#### 4. 飞书集成模块 (Lark Integration Module)

- 多维表格API调用
- 数据同步服务
- 批量操作支持
- Upsert操作支持

#### 5. 用户模块 (User Module)

- 用户信息管理
- 权限控制
- 用户档案管理

#### 6. 邮件模块 (Email Module)

- 邮件发送服务
- 模板管理
- 发送记录跟踪

### 共享库

#### 1. 飞书集成库 (Integrations-Lark)

- Bitable服务
- 飞书客户端
- 数据仓库
- 验证器

## 数据流设计

### 腾讯会议事件处理流程

```text
1. 腾讯会议平台发送Webhook事件
         ↓
2. Webhook控制器接收并验证请求
         ↓
3. 事件处理器工厂分发事件
         ↓
4. 具体事件处理器处理业务逻辑
         ↓
5. 数据持久化到PostgreSQL数据库
         ↓
6. (可选) 同步数据到飞书多维表格
```

### 会议录制文件处理流程

```text
1. 接收录制完成事件
         ↓
2. 调用腾讯会议API获取录制文件详情
         ↓
3. 下载录制文件
         ↓
4. 存储文件到对象存储
         ↓
5. 提取文件元数据
         ↓
6. 创建或更新数据库记录
         ↓
7. (可选) 同步到飞书多维表格
```

## 数据库设计

### 核心实体关系

```text
User 1───────┐
              ├── UserOrganization
Organization──┘

User 1───────┐
              ├── UserDepartment
Department───┘

User 1───────┐
              ├── UserRole
Role 1───────┤
              ├── RolePermission
Permission───┘

User 1───────┐
              ├── UserPermission
Permission───┘

Meetings 1───┐
              ├── MeetingParticipation
PlatformUser─┘

Meetings 1───┐
              ├── MeetingFile
User─────────┘

Meetings 1───┐
              ├── MeetingTranscript
User─────────┘

Meetings 1───┐
              ├── MeetingSummary
MeetingFile──┘
```

## 部署架构

### 开发环境

- 单实例应用
- 本地PostgreSQL数据库
- 开发者个人飞书应用
- 本地对象存储模拟

### 生产环境

- 多实例负载均衡
- 主从数据库集群
- 企业级飞书应用
- 云对象存储服务
- 监控和日志系统

## 安全设计

### 认证与授权

- JWT Token认证
- RBAC权限控制
- API密钥管理
- 请求签名验证

### 数据安全

- 敏感信息加密存储
- HTTPS通信
- 数据库连接加密
- 文件传输加密

### 应用安全

- 输入验证和过滤
- SQL注入防护
- XSS防护
- CSRF防护

## 性能优化

### 数据库优化

- 索引优化
- 查询优化
- 连接池管理
- 读写分离

### API优化

- 缓存策略
- 分页处理
- 异步处理
- 批量操作

### 集成优化

- 连接池复用
- 请求合并
- 异步处理
- 错误重试机制

## 监控与日志

### 日志级别

- ERROR: 错误信息
- WARN: 警告信息
- INFO: 一般信息
- DEBUG: 调试信息

### 监控指标

- API响应时间
- 数据库查询性能
- 第三方服务调用成功率
- 系统资源使用情况

## 扩展性设计

### 水平扩展

- 无状态应用设计
- 数据库读写分离
- 缓存集群
- 负载均衡

### 功能扩展

- 插件化架构
- 事件驱动设计
- 微服务拆分
- API网关管理

## 版本管理

### API版本控制

- URL路径版本控制: `/api/v1/`
- 向后兼容性保证
- 版本迁移策略

### 数据库版本控制

- Prisma Migrate
- 数据库迁移脚本
- 回滚机制

## 故障处理

### 容错机制

- 服务降级
- 熔断机制
- 超时控制
- 重试机制

### 数据备份

- 定期数据库备份
- 文件备份策略
- 灾难恢复计划
